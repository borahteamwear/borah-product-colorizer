var TB_ProductColorizer=function(t){var e={},o={elements:[]};o.get=function(e){return-1!==t.inArray(e,o.elements)?o.elements[e]:(o.elements[e]=jQuery(e),o.elements[e])},o.refresh=function(t){t.elements[t]=jQuery(t)};var n=function(){if(void 0!==wp.media){var e=[],n=wp.media.model.settings.post.id;o.get("body").on("click",".tb_wpc_upload_image_button",function(o){o.preventDefault(),console.log("clicked");var c=t(this),a=c.attr("id"),i=jQuery("#"+c.data("input").replace(/\[/g,"\\[").replace(/\]/g,"\\]")),r=parseInt(i.val())||!1;if(e[a])return e[a].uploader.uploader.param("post_id",r),void e[a].open();wp.media.model.settings.post.id=r,e[a]=wp.media.frames.file_frame=wp.media({title:"Select a mask image to upload",button:{text:c.data("media-button-text")||"Use This Image Mask"},multiple:!1,library:{type:"image/svg+xml"}}),e[a].on("select",function(){var t=e[a].state().get("selection").first().toJSON();jQuery("#"+c.data("preview")).attr("src",t.url),i.val(t.id),wp.media.model.settings.post.id=n}),e[a].open()}).on("click","a.add_media",function(){wp.media.model.settings.post.id=n})}};e.loadImages=function(){i({action:"tb_wpc_images",id:tb_wpc.postId,nonce:tb_wpc.nonce},function(t){o.get("#tb-wpc-templates-container").html(t)})},e.addNewImage=function(){o.get("body").on("click","#tb_wpc_add_new_image_template",function(){var e=t("#tb-wpc-templates-container > .tb-wpc-template[data-image]").length;i({action:"tb_wpc_images",total:e,nonce:tb_wpc.nonce},function(t){o.get("#tb-wpc-templates-container").append(t)})})},e.save=function(){var e=o.get("#woocommerce-product-data");e.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),i({action:"tb_wpc_save",nonce:tb_wpc.nonce,id:tb_wpc.postId,data:decodeURIComponent(t(".tb_wpc_form").serialize())},function(t){e.unblock()})};var c=function(){o.get("body").on("click","#tb_wpc_save_top",function(t){t.preventDefault(),e.save()}).on("click","#product_colorizer_tab a.tb-wpc-remove-color",function(e){e.preventDefault(),t(this).parents(".options_group[data-color]").remove()}).on("click","#product_colorizer_tab a.tb-wpc-remove-template",function(e){e.preventDefault(),t(this).parents(".options_group[data-template]").remove()}).on("click","#tb_wpc_add_new_image_template a.tb-wpc-remove-element",function(e){e.preventDefault(),t(this).parents(".tb-wpc-template[data-image]").remove()}).on("click","#tb_wpc_discounts_tab a.tb-wpc-remove-discount",function(e){e.preventDefault(),t(this).parents(".options_group[data-discount]").remove()}).on("change","#tb_wpc_discounts_tab .tb_wpc_type_selector",function(e){var o=t(this),n=o.parents(".options_group[data-discount]");n.find(".tb_wpc_type_container").hide(),n.find('.tb_wpc_type_container[data-type="'+o.val()+'"]').show()}).on("click","a.cancel_discount_schedule",function(e){e.preventDefault();var o=t(this),n=o.parents(".options_group[data-discount]");o.hide(),n.find("a.discount_schedule").show(),n.find(".discount_price_dates_fields").hide()}).on("click","a.discount_schedule",function(e){e.preventDefault();var o=t(this),n=o.parents(".options_group[data-discount]");o.hide(),n.find("a.cancel_discount_schedule").show(),n.find(".discount_price_dates_fields").show()})};e.loadColors=function(){i({action:"tb_wpc_colors",id:tb_wpc.postId,nonce:tb_wpc.nonce},function(n){var c=o.get("#product_colorizer_tab").find(".tb_wpc_colors_container");c.html(n),c.find("select.tb_wpc_palette").each(function(){e.getPaletteColors(t(this))})})},e.addNewColor=function(){o.get("body").on("click","#tb_wpc_add_color_top",function(){var e=t("#product_colorizer_tab > .tb_wpc_colors_container > .options_group[data-color]").length;i({action:"tb_wpc_colors",total:e,nonce:tb_wpc.nonce},function(t){o.get("#product_colorizer_tab").find(".tb_wpc_colors_container").append(t)})})},e.loadTemplates=function(){i({action:"tb_wpc_templates",id:tb_wpc.postId,nonce:tb_wpc.nonce},function(t){o.get("#product_colorizer_tab").find(".tb_wpc_templates_container").html(t)})},e.addNewTemplate=function(){o.get("body").on("click","#tb_wpc_add_top",function(){var e=t("#product_colorizer_tab > .tb_wpc_templates_container > .options_group[data-template]").length;i({action:"tb_wpc_templates",total:e,nonce:tb_wpc.nonce},function(t){o.get("#product_colorizer_tab").find(".tb_wpc_templates_container").append(t)})})};var a=function(){t(".tb_wpc_colorPicker").each(function(){var e=t(this);0<e.find('> .colorpicker[id^="collorpicker_"]').length?e.ColorPickerSetColor(jQuery("#"+e.data("target")).val()):e.ColorPicker({flat:!0,color:jQuery("#"+e.data("target")).val(),onSubmit:function(t,e,o,n){jQuery("#"+jQuery(n).data("target")).val(e)}})})};e.loadDiscounts=function(){i({action:"tb_wpc_discounts",id:tb_wpc.postId,nonce:tb_wpc.nonce},function(e){o.get("#tb_wpc_discounts_tab").find(".tb_wpc_discounts_container").html(e),t("#tb_wpc_discounts_tab .tb_wpc_form.hasDatepicker").datepicker()})},e.addNewDiscount=function(){o.get("body").on("click","#tb_wpc_add_top",function(){var e=t("#tb_wpc_discounts_tab > .tb_wpc_discounts_container > .options_group[data-discount]").length;i({action:"tb_wpc_discounts",total:e,nonce:tb_wpc.nonce},function(t){o.get("#tb_wpc_discounts_tab").find(".tb_wpc_discounts_container").append(t),isNaN(e)&&(e=0);var n=e+1;o.get("#tb_wpc_discounts_tab").find('.discount_price_dates_fields[data-target="'+n+'"]').find(".tb_wpc_form.hasDatepicker").datepicker()})})},e.getColors=function(){o.get("body").on("change","select.tb_wpc_palette",function(){e.getPaletteColors(t(this))})},e.getPaletteColors=function(e){var o=parseInt(e.val());if(!isNaN(o)){var n=e.parents(".options_group[data-color]").find("select.tb_wpc_defaultColor");i({action:"tb_wpc_palette_colors",paletteId:o,nonce:tb_wpc.nonce},function(e){if(!e)return!1;n.append(t("<option>",{value:"",text:"Select a Default Color"}));for(var o in e)e.hasOwnProperty(o)&&n.append(t("<option>",{value:o,text:e[o]}));var c=n.data("selected-color");n.find('option[value="'+c+'"]').prop("selected",!0)})}};var i=function(e,o,n){void 0===n&&(n="json"),t.ajax({url:ajaxurl,type:"post",dataType:n,cache:!1,data:e,error:function(t,e,o){console.log(t.status+" "+t.statusText+"---"+e),console.log(e)},success:function(t){"function"==typeof o&&o(t)},statusCode:{404:function(){console.log("Something went wrong; can't find ajax request URL!")},500:function(){console.log("Something went wrong; internal server error while processing the request!")}}})};return e.init=function(){e.loadImages(),e.addNewImage(),n(),a(),e.loadColors(),e.addNewColor(),e.getColors(),e.loadTemplates(),e.addNewTemplate(),e.loadDiscounts(),e.addNewDiscount(),c()},e}(jQuery);jQuery(document).ready(function(){TB_ProductColorizer.init()});